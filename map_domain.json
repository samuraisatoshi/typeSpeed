{
  "domains": {
    "shared": {
      "description": "Shared kernel with cross-cutting concerns and base abstractions",
      "goal": "Provide common base classes, value objects, and interfaces",
      "dependencies": [],
      "classes": {
        "ValueObject": {
          "type": "Abstract Base Class",
          "description": "Base class for all value objects in the domain",
          "goal": "Ensure value objects are immutable and implement value-based equality",
          "methods": ["equals", "hashCode"],
          "dependencies": []
        },
        "Entity": {
          "type": "Abstract Base Class",
          "description": "Base class for all domain entities with identity",
          "goal": "Ensure entities have unique identity and support lifecycle operations",
          "methods": ["getId", "equals"],
          "dependencies": []
        },
        "Language": {
          "type": "Value Object",
          "description": "Value object representing programming languages",
          "goal": "Encapsulate language properties and behaviors with immutability",
          "methods": ["fromExtension", "getExtensions", "getFormatter", "getConfig", "equals", "toString"],
          "dependencies": []
        },
        "FilePath": {
          "type": "Value Object",
          "description": "Value object for file paths with validation",
          "goal": "Ensure valid, normalized file path handling",
          "methods": ["validate", "normalize", "getExtension", "getFileName", "getDirectory", "equals", "toString"],
          "dependencies": []
        },
        "PathValidator": {
          "type": "Value Object",
          "description": "Value object for validating and sanitizing file system paths",
          "goal": "Provide protection against path traversal attacks and ensure paths are within allowed directories",
          "methods": ["create", "validatePathSafety", "isWithinAllowedPaths", "getAbsolutePath", "toString"],
          "dependencies": []
        },
        "SecurityConfig": {
          "type": "Value Object",
          "description": "Value object representing security configuration for the application",
          "goal": "Encapsulate all security-related settings in an immutable object",
          "methods": ["create", "getAllowedScanPaths", "getTrustedOrigins", "getMaxRequestsPerMinute", "getMaxScanDepth", "getMaxFileSize", "withAdditionalPaths", "withAdditionalOrigins"],
          "dependencies": []
        },
        "InputValidator": {
          "type": "Service",
          "description": "Service for validating user inputs",
          "goal": "Provide domain-level input validation to prevent injection attacks",
          "methods": ["validateSingleCharacter", "validateNonEmptyString", "validateNumberInRange", "validateSessionId", "validateLanguageName", "validateUserId", "sanitizeText", "validateRequiredProperties", "validateInteger"],
          "dependencies": []
        }
      }
    },
    "codeSource": {
      "description": "Domain for managing source code files and project folder scanning",
      "goal": "Handle file system access, code file discovery, and language detection",
      "dependencies": ["shared"],
      "classes": {
        "CodeFile": {
          "type": "Entity",
          "description": "Represents a source code file with metadata",
          "goal": "Encapsulate code file data including content, language, and metadata",
          "methods": ["getId", "getPath", "getLanguage", "getContent", "getSize", "getLastModified"],
          "dependencies": ["FilePath", "Language"]
        },
        "ProjectScanner": {
          "type": "Service",
          "description": "Scans selected folders for source code files",
          "goal": "Discover and catalog available code files from a directory",
          "methods": ["scanFolder", "getScannedFiles", "filterByLanguage"],
          "dependencies": ["fs", "path", "CodeFile", "Language"]
        },
        "CodeFileRepository": {
          "type": "Repository Interface",
          "description": "Repository interface for managing discovered code files",
          "goal": "Define contract for storing and retrieving code files with metadata",
          "methods": ["store", "findById", "findByLanguage", "getRandomFile", "getAll", "delete"],
          "dependencies": []
        },
        "InMemoryCodeFileRepository": {
          "type": "Repository Implementation",
          "description": "In-memory implementation of CodeFileRepository",
          "goal": "Provide temporary in-memory storage for code files during session",
          "methods": ["store", "findById", "findByLanguage", "getRandomFile", "getAll", "delete"],
          "dependencies": ["CodeFileRepository", "CodeFile"]
        }
      }
    },
    "codeFormatter": {
      "description": "Domain for code formatting and syntax highlighting",
      "goal": "Format code according to language standards and prepare for display",
      "dependencies": ["codeSource", "shared"],
      "classes": {
        "Formatter": {
          "type": "Interface",
          "description": "Interface for language-specific code formatters",
          "goal": "Define contract for formatting code with language-specific rules",
          "methods": ["format", "formatWithHighlight"],
          "dependencies": []
        },
        "FormatterFactory": {
          "type": "Factory Service",
          "description": "Factory for creating and managing language-specific formatters",
          "goal": "Provide appropriate formatter instance for each language",
          "methods": ["createFormatter", "registerFormatter", "getFormatter"],
          "dependencies": ["Formatter", "Language"]
        },
        "SyntaxHighlighter": {
          "type": "Service",
          "description": "Applies syntax highlighting to formatted code",
          "goal": "Enhance code readability with proper syntax highlighting",
          "methods": ["highlight", "getTheme", "setTheme", "getAvailableThemes"],
          "dependencies": ["highlight.js"]
        }
      }
    },
    "typing": {
      "description": "Core typing mechanics and session management",
      "goal": "Handle typing sessions, input processing, and real-time feedback",
      "dependencies": ["codeFormatter", "codeSource", "shared"],
      "classes": {
        "TypingSession": {
          "type": "Aggregate Root",
          "description": "Manages individual typing sessions and user input",
          "goal": "Track user typing progress, input validation, and session state",
          "methods": ["start", "processInput", "end", "getStatus", "getElapsedTime", "getTypedContent", "isCompleted"],
          "dependencies": ["CodeFile", "MetricsCalculator"]
        },
        "MetricsCalculator": {
          "type": "Service",
          "description": "Calculates typing performance metrics from session data",
          "goal": "Compute WPM, accuracy, and detailed statistics from typing data",
          "methods": ["calculateWPM", "calculateAccuracy", "calculateErrorRate", "getCharacterStats", "getTimeStats", "calculateConsistency"],
          "dependencies": []
        }
      }
    },
    "statistics": {
      "description": "Domain for tracking and analyzing performance statistics",
      "goal": "Store, analyze, and present typing performance data",
      "dependencies": ["typing", "shared"],
      "classes": {
        "SessionStatistics": {
          "type": "Value Object",
          "description": "Immutable statistics snapshot from a completed typing session",
          "goal": "Encapsulate and preserve session performance metrics",
          "methods": ["getWPM", "getAccuracy", "getErrorRate", "getDuration", "getLanguage", "getTimestamp", "equals"],
          "dependencies": ["Language"]
        },
        "StatisticsRepository": {
          "type": "Repository Interface",
          "description": "Repository interface for persisting typing statistics",
          "goal": "Define contract for storing and retrieving historical performance data",
          "methods": ["save", "findById", "findByLanguage", "findByDateRange", "getAll", "delete"],
          "dependencies": []
        },
        "InMemoryStatisticsRepository": {
          "type": "Repository Implementation",
          "description": "In-memory implementation of StatisticsRepository",
          "goal": "Provide temporary in-memory storage for session statistics",
          "methods": ["save", "findById", "findByLanguage", "findByDateRange", "getAll", "delete"],
          "dependencies": ["StatisticsRepository", "SessionStatistics"]
        }
      }
    },
    "application": {
      "description": "Application layer with use cases and command handlers",
      "goal": "Orchestrate domain services to fulfill user requests",
      "dependencies": ["codeSource", "codeFormatter", "typing", "statistics", "shared"],
      "classes": {
        "ScanProjectCommand": {
          "type": "Command",
          "description": "Use case for scanning a project folder for code files",
          "goal": "Coordinate project scanning and repository population",
          "methods": ["execute"],
          "dependencies": ["ProjectScanner", "CodeFileRepository"]
        },
        "StartTypingSessionCommand": {
          "type": "Command",
          "description": "Use case for initiating a new typing session",
          "goal": "Set up and initialize a typing session with selected code",
          "methods": ["execute"],
          "dependencies": ["CodeFileRepository", "TypingSession", "FormatterFactory"]
        }
      }
    },
    "infrastructure": {
      "description": "Infrastructure layer with web server and external integrations",
      "goal": "Provide HTTP endpoints and technical implementations",
      "dependencies": ["application", "codeSource", "typing", "statistics", "shared"],
      "classes": {
        "server": {
          "type": "Web Server",
          "description": "Express.js web server for TypeSpeed API",
          "goal": "Expose application services via HTTP REST endpoints with security measures",
          "methods": ["setupRoutes", "handleProjectScan", "handleTypingSession", "handleStatistics"],
          "dependencies": ["express", "application layer services", "SecurityMiddleware", "SecurityConfig", "PathValidator", "InputValidator"]
        },
        "SecurityMiddleware": {
          "type": "Infrastructure Service",
          "description": "Infrastructure service for configuring security middleware",
          "goal": "Provide helmet configuration, rate limiting, and CORS settings",
          "methods": ["getHelmetMiddleware", "getGeneralRateLimiter", "getStrictRateLimiter", "getCorsOptions", "securityLogger", "requestSizeValidator", "commonSecurityMiddleware"],
          "dependencies": ["helmet", "express-rate-limit", "SecurityConfig"]
        }
      }
    },
    "presentation": {
      "description": "UI presentation layer for managing viewport and display concerns",
      "goal": "Provide clean separation between domain logic and UI rendering with proper viewport state management",
      "dependencies": ["shared"],
      "classes": {
        "ScrollPositionStrategy": {
          "type": "Strategy Interface",
          "description": "Strategy pattern interface for scroll position management",
          "goal": "Define contract for different scroll positioning behaviors",
          "methods": ["apply"],
          "dependencies": []
        },
        "TopScrollStrategy": {
          "type": "Concrete Strategy",
          "description": "Strategy to position viewport at the top of content",
          "goal": "Ensure content display starts at the beginning (critical for typing sessions)",
          "methods": ["apply", "_preventPendingScrolls"],
          "dependencies": ["ScrollPositionStrategy"]
        },
        "PreserveScrollStrategy": {
          "type": "Concrete Strategy",
          "description": "Strategy to maintain current scroll position during updates",
          "goal": "Preserve user's viewport position when content is refreshed",
          "methods": ["apply"],
          "dependencies": ["ScrollPositionStrategy"]
        },
        "SmoothScrollToElementStrategy": {
          "type": "Concrete Strategy",
          "description": "Strategy to smoothly scroll element into view with buffer zones",
          "goal": "Keep current typing position visible with smooth scrolling behavior",
          "methods": ["apply"],
          "dependencies": ["ScrollPositionStrategy"]
        },
        "ViewportManager": {
          "type": "Domain Service",
          "description": "Domain service for managing viewport state and scroll behavior",
          "goal": "Coordinate scroll position management and prevent unwanted browser auto-scroll",
          "methods": ["lockScroll", "executeProtectedUpdate", "applyStrategy", "captureCurrentPosition", "isScrollLocked", "getContainer"],
          "dependencies": ["ScrollPositionStrategy"]
        },
        "CodeDisplayPresenter": {
          "type": "Application Service / Presenter",
          "description": "Application service orchestrating code display with viewport management",
          "goal": "Coordinate syntax highlighting, character span generation, and scroll control",
          "methods": ["displayCode", "updateCharacterState", "getCharacterAt", "clearCharacterStates", "displayPlaceholder", "_convertToCharacterSpans", "_createCharSpan", "_escapeHtml"],
          "dependencies": ["ViewportManager", "ScrollPositionStrategy"]
        },
        "FeedbackPresenter": {
          "type": "Presentation Service",
          "description": "Presenter for user feedback and toast notifications",
          "goal": "Provide consistent user feedback abstraction isolating UI concerns from domain logic",
          "methods": ["showError", "showSuccess", "showWarning", "showInfo", "showLoading", "_show", "_dismissToast", "_ensureStylesPresent"],
          "dependencies": ["ToastNotificationFactory"]
        },
        "ToastNotificationFactory": {
          "type": "Factory",
          "description": "Factory for creating toast notification DOM elements",
          "goal": "Encapsulate toast element creation for testability and customization",
          "methods": ["create", "_sanitizeMessage"],
          "dependencies": []
        }
      }
    },
    "sessionCompletion": {
      "description": "Application services for coordinating typing session completion workflow",
      "goal": "Handle session completion with proper async sequencing, error handling, and user feedback",
      "dependencies": ["typing", "infrastructure", "presentation"],
      "classes": {
        "SessionCompletionCoordinator": {
          "type": "Application Service",
          "description": "Coordinates session completion workflow preventing race conditions",
          "goal": "Sequence async operations properly and handle completion errors with user feedback",
          "methods": ["completeSession", "completeSessionWithFeedback", "validateSessionForCompletion"],
          "dependencies": ["HttpClient", "FeedbackPresenter", "SessionCompletionResult"]
        },
        "SessionCompletionResult": {
          "type": "Value Object",
          "description": "Immutable result of a completed typing session",
          "goal": "Encapsulate all completion metrics and metadata in immutable structure",
          "methods": ["fromServerResponse", "getFormattedDuration", "getRoundedWPM", "getFormattedAccuracy", "isSuccessful", "equals"],
          "dependencies": []
        },
        "SessionCompletionError": {
          "type": "Domain Exception",
          "description": "Specialized error for session completion failures",
          "goal": "Provide both technical details and user-friendly error messages",
          "methods": ["getUserMessage", "isRecoverable"],
          "dependencies": []
        }
      }
    },
    "httpInfrastructure": {
      "description": "Infrastructure services for HTTP communication",
      "goal": "Provide abstraction over fetch API for application layer",
      "dependencies": ["shared"],
      "classes": {
        "HttpClient": {
          "type": "Infrastructure Service",
          "description": "HTTP client abstraction for REST API communication",
          "goal": "Encapsulate fetch API details and support dependency injection for testing",
          "methods": ["get", "post", "put", "delete", "setDefaultHeader", "removeDefaultHeader", "_request", "_buildUrl"],
          "dependencies": []
        },
        "HttpClientError": {
          "type": "Infrastructure Exception",
          "description": "Specialized error for HTTP operation failures",
          "goal": "Wrap network errors with contextual information",
          "methods": [],
          "dependencies": []
        }
      }
    }
  },
  "metadata": {
    "version": "3.3.0",
    "lastUpdated": "2025-11-03",
    "architecture": "Domain-Driven Design with SOLID principles",
    "project": "TypeSpeed - Code Typing Practice Application",
    "implementation_status": "Core architecture with security hardening, UI presentation layer, and session completion coordination",
    "implemented_domains": ["shared", "codeSource", "codeFormatter", "typing", "statistics", "application", "infrastructure", "presentation", "sessionCompletion", "httpInfrastructure"],
    "security_features": [
      "Path traversal protection with PathValidator",
      "CORS whitelist with SecurityConfig",
      "Rate limiting on all API endpoints",
      "Strict rate limiting on expensive operations",
      "Input validation on all user inputs",
      "XSS prevention in frontend",
      "Security headers with Helmet",
      "Request size validation"
    ],
    "recent_improvements": [
      {
        "date": "2025-11-03",
        "description": "Fixed critical race condition in session completion and added proper userId handling",
        "problem_solved": "Race condition where sessionActive was set false before async completion, missing userId in completion request, missing bounds checking in DOM access",
        "bugs_fixed": [
          "CRITICAL: Race condition in completeSession() causing late or missing results modal",
          "IMPORTANT: Missing userId in session completion request defaulting to 'default' user",
          "MINOR: Missing bounds check in updateCharacterDisplayInstant() causing silent failures"
        ],
        "architectural_patterns": ["Application Service", "Value Object", "Presenter Pattern", "Factory Pattern", "Dependency Injection"],
        "solid_principles_applied": ["Single Responsibility", "Open/Closed", "Dependency Inversion", "Interface Segregation", "Liskov Substitution"],
        "new_components": [
          "SessionCompletionCoordinator: Application service coordinating async session completion",
          "SessionCompletionResult: Value object for immutable completion data",
          "SessionCompletionError: Domain exception with user-friendly messages",
          "FeedbackPresenter: Presentation service for user feedback abstraction",
          "ToastNotificationFactory: Factory for toast DOM elements",
          "HttpClient: Infrastructure service abstracting fetch API"
        ]
      },
      {
        "date": "2025-11-03",
        "description": "Added Presentation domain with ViewportManager and scroll strategies",
        "problem_solved": "Fixed critical scrolling bug where code display auto-scrolled to bottom on session start",
        "architectural_patterns": ["Strategy Pattern", "Template Method Pattern", "Domain Service"],
        "solid_principles_applied": ["Single Responsibility", "Open/Closed", "Dependency Inversion", "Interface Segregation"]
      }
    ]
  }
}